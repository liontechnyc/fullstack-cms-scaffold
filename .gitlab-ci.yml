image: node:latest

variables:
  APP_ID: lts-cms-core
  PG_PLAN: hobby-dev

stages:
  - build
  - deploy

cache:
  paths:
    - frontend/node_modules/

build_frontend:
  stage: build
  before_script:
    - npm --prefix frontend install
  script:
    - sed -i s/__APP_ID__/${APP_ID}/g frontend/.env-cmdrc.json
    - npm --prefix frontend run build
  artifacts:
    paths:
      - frontend/public

deploy_to_heroku:
  stage: deploy

  only:
    - master

  before_script:
    - npm install -g heroku
    - heroku create $APP_ID || echo 'App already exist, skipping app creation...'
    - heroku addons:create heroku-postgresql:$PG_PLAN --app $APP_ID --name lts-pg-$APP_ID --wait || echo 'DB already exist, skipping creation...'

  script:
    - git add .
    - git commit -m "commit for deploy to heroku"
    - git push -f https://heroku:$HEROKU_API_KEY@git.heroku.com/$APP_ID.git master

deploy_to_netlify:
  stage: deploy
  
  before_script:
    - npm install netlify-cli -g
    - netlify --telemetry-disable
  script:
    - netlify deploy --site $NETLIFY_SITE_ID --auth $NETLIFY_AUTH_TOKEN --prod
